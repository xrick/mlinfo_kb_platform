<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesRAG ç³»çµ±æ¸¬è©¦ä»‹é¢</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result-area {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .message.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        .message.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .message.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
        }
        .message.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .clarification-options {
            margin-top: 10px;
        }
        .clarification-option {
            display: block;
            margin: 5px 0;
            padding: 8px;
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            cursor: pointer;
        }
        .clarification-option:hover {
            background-color: #bbdefb;
        }
        .quick-test-buttons {
            margin-top: 15px;
        }
        .quick-test-buttons button {
            background-color: #28a745;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .quick-test-buttons button:hover {
            background-color: #218838;
        }
        .json-display {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– SalesRAG æ™ºèƒ½ç­†é›»æ¨è–¦ç³»çµ±æ¸¬è©¦ä»‹é¢</h1>
        
        <!-- åŸºæœ¬æŸ¥è©¢æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ’¬ åŸºæœ¬æŸ¥è©¢æ¸¬è©¦</h2>
            <div class="input-group">
                <label for="basicQuery">è¼¸å…¥æŸ¥è©¢:</label>
                <input type="text" id="basicQuery" placeholder="ä¾‹å¦‚ï¼šæ¯”è¼ƒ 958 å’Œ 819 ç³»åˆ—çš„ CPU æ€§èƒ½">
            </div>
            <button onclick="testBasicQuery()">ç™¼é€æŸ¥è©¢</button>
            <div class="quick-test-buttons">
                <button onclick="quickTest('æ¯”è¼ƒ 958 å’Œ 819 ç³»åˆ—çš„ CPU æ€§èƒ½')">CPU æ€§èƒ½æ¯”è¼ƒ</button>
                <button onclick="quickTest('æœ€æ–°çš„éŠæˆ²ç­†é›»æœ‰å“ªäº›ï¼Ÿ')">éŠæˆ²ç­†é›»æŸ¥è©¢</button>
                <button onclick="quickTest('é©åˆå•†å‹™ä½¿ç”¨çš„è¼•è–„ç­†é›»')">å•†å‹™ç­†é›»æŸ¥è©¢</button>
                <button onclick="quickTest('æˆ‘æƒ³è¦ä¸€å°ç­†é›»')">è§¸ç™¼æ¾„æ¸…å°è©±</button>
            </div>
            <div class="result-area" id="basicResult"></div>
        </div>

        <!-- æ¾„æ¸…å°è©±æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ” æ¾„æ¸…å°è©±æ¸¬è©¦</h2>
            <div class="input-group">
                <label for="clarificationQuery">æ¨¡ç³ŠæŸ¥è©¢ (æœƒè§¸ç™¼æ¾„æ¸…å°è©±):</label>
                <input type="text" id="clarificationQuery" placeholder="ä¾‹å¦‚ï¼šæˆ‘éœ€è¦ä¸€å°ç­†é›»">
            </div>
            <button onclick="testClarificationTrigger()">è§¸ç™¼æ¾„æ¸…å°è©±</button>
            <div class="quick-test-buttons">
                <button onclick="quickClarificationTest('æˆ‘æƒ³è¦ä¸€å°ç­†é›»')">åŸºæœ¬éœ€æ±‚</button>
                <button onclick="quickClarificationTest('æœ‰ä»€éº¼æ¨è–¦çš„å—ï¼Ÿ')">ä¸€èˆ¬æ¨è–¦</button>
                <button onclick="quickClarificationTest('ç­†é›»è¦æ ¼')">è¦æ ¼æŸ¥è©¢</button>
            </div>
            <div class="result-area" id="clarificationResult"></div>
        </div>

        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div class="test-section">
            <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹</h2>
            <button onclick="checkSystemStatus()">æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
            <button onclick="clearAllResults()">æ¸…é™¤æ‰€æœ‰çµæœ</button>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalQueries">0</div>
                    <div class="stat-label">ç¸½æŸ¥è©¢æ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="clarificationTriggered">0</div>
                    <div class="stat-label">æ¾„æ¸…å°è©±è§¸ç™¼æ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageResponseTime">0ms</div>
                    <div class="stat-label">å¹³å‡å›æ‡‰æ™‚é–“</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">100%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            </div>
            <div class="result-area" id="systemStatus"></div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentConversationId = null;
        let stats = {
            totalQueries: 0,
            clarificationTriggered: 0,
            totalResponseTime: 0,
            successfulQueries: 0
        };

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            document.getElementById('totalQueries').textContent = stats.totalQueries;
            document.getElementById('clarificationTriggered').textContent = stats.clarificationTriggered;
            document.getElementById('averageResponseTime').textContent = 
                stats.totalQueries > 0 ? Math.round(stats.totalResponseTime / stats.totalQueries) + 'ms' : '0ms';
            document.getElementById('successRate').textContent = 
                stats.totalQueries > 0 ? Math.round((stats.successfulQueries / stats.totalQueries) * 100) + '%' : '100%';
        }

        // æ·»åŠ è¨Šæ¯åˆ°çµæœå€åŸŸ
        function addMessage(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // åŸºæœ¬æŸ¥è©¢æ¸¬è©¦
        async function testBasicQuery() {
            const query = document.getElementById('basicQuery').value.trim();
            if (!query) {
                addMessage('basicResult', 'è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹', 'warning');
                return;
            }
            
            await performQuery(query, 'basicResult');
        }

        // å¿«é€Ÿæ¸¬è©¦
        async function quickTest(query) {
            document.getElementById('basicQuery').value = query;
            await performQuery(query, 'basicResult');
        }

        // åŸ·è¡ŒæŸ¥è©¢
        async function performQuery(query, containerId) {
            const startTime = Date.now();
            stats.totalQueries++;
            
            addMessage(containerId, `ç™¼é€æŸ¥è©¢: ${query}`, 'info');
            
            try {
                const response = await fetch('/api/chat-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        service_name: "sales_assistant"
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'è«‹æ±‚å¤±æ•—');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    fullResponse += chunk;
                    
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleQueryResponse(data, containerId);
                            } catch (e) {
                                console.log('è§£æ JSON å¤±æ•—:', e);
                            }
                        }
                    }
                }

                const endTime = Date.now();
                stats.totalResponseTime += (endTime - startTime);
                stats.successfulQueries++;
                addMessage(containerId, `æŸ¥è©¢å®Œæˆ (è€—æ™‚: ${endTime - startTime}ms)`, 'success');

            } catch (error) {
                addMessage(containerId, `æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
            
            updateStats();
        }

        // è™•ç†æŸ¥è©¢å›æ‡‰
        function handleQueryResponse(data, containerId) {
            if (data.message_type === 'clarification_request') {
                stats.clarificationTriggered++;
                currentConversationId = data.conversation_id;
                addMessage(containerId, `ğŸ” è§¸ç™¼æ¾„æ¸…å°è©± (ID: ${data.conversation_id})`, 'warning');
                addMessage(containerId, `æ¾„æ¸…å•é¡Œ: ${data.question}`, 'info');
                
                // é¡¯ç¤ºæ¾„æ¸…é¸é …
                const optionsHtml = data.options.map(option => 
                    `<div class="clarification-option" onclick="respondToClarification('${option.id}', '${containerId}')">
                        ${option.label} - ${option.description}
                    </div>`
                ).join('');
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'clarification-options';
                optionsContainer.innerHTML = `<strong>è«‹é¸æ“‡:</strong>${optionsHtml}`;
                document.getElementById(containerId).appendChild(optionsContainer);
                
            } else if (data.answer_summary) {
                addMessage(containerId, `ğŸ“ å›æ‡‰æ‘˜è¦: ${data.answer_summary.substring(0, 200)}...`, 'success');
                
                if (data.comparison_table && data.comparison_table.length > 0) {
                    addMessage(containerId, `ğŸ“Š åŒ…å«æ¯”è¼ƒè¡¨æ ¼ (${data.comparison_table.length} é …)`, 'info');
                }
            }
        }

        // æ¾„æ¸…å°è©±æ¸¬è©¦
        async function testClarificationTrigger() {
            const query = document.getElementById('clarificationQuery').value.trim();
            if (!query) {
                addMessage('clarificationResult', 'è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹', 'warning');
                return;
            }
            
            await performQuery(query, 'clarificationResult');
        }

        // å¿«é€Ÿæ¾„æ¸…æ¸¬è©¦
        async function quickClarificationTest(query) {
            document.getElementById('clarificationQuery').value = query;
            await performQuery(query, 'clarificationResult');
        }

        // å›æ‡‰æ¾„æ¸…å•é¡Œ
        async function respondToClarification(choice, containerId) {
            if (!currentConversationId) {
                addMessage(containerId, 'æ²’æœ‰æ´»èºçš„æ¾„æ¸…å°è©±', 'error');
                return;
            }

            addMessage(containerId, `âœ… é¸æ“‡: ${choice}`, 'info');

            try {
                const response = await fetch('/api/clarification-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        user_choice: choice,
                        user_input: "",
                        service_name: "sales_assistant"
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'æ¾„æ¸…å›æ‡‰å¤±æ•—');
                }

                const result = await response.json();
                handleClarificationResponse(result, containerId);

            } catch (error) {
                addMessage(containerId, `æ¾„æ¸…å›æ‡‰å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è™•ç†æ¾„æ¸…å›æ‡‰
        function handleClarificationResponse(result, containerId) {
            if (result.message_type === 'clarification_request') {
                addMessage(containerId, `ğŸ”„ ç¹¼çºŒæ¾„æ¸…: ${result.question}`, 'info');
                
                const optionsHtml = result.options.map(option => 
                    `<div class="clarification-option" onclick="respondToClarification('${option.id}', '${containerId}')">
                        ${option.label} - ${option.description}
                    </div>`
                ).join('');
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'clarification-options';
                optionsContainer.innerHTML = `<strong>è«‹é¸æ“‡:</strong>${optionsHtml}`;
                document.getElementById(containerId).appendChild(optionsContainer);
                
            } else if (result.message_type === 'final_response') {
                addMessage(containerId, 'ğŸ‰ æ¾„æ¸…å®Œæˆ!', 'success');
                addMessage(containerId, `æ¾„æ¸…ç¸½çµ: ${result.clarification_summary}`, 'info');
                addMessage(containerId, `æœ€çµ‚å›æ‡‰: ${result.answer_summary.substring(0, 200)}...`, 'success');
                currentConversationId = null;
                
            } else if (result.message_type === 'error') {
                addMessage(containerId, `âŒ éŒ¯èª¤: ${result.answer_summary}`, 'error');
            }
        }

        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/get-services');
                const data = await response.json();
                
                addMessage('systemStatus', `ç³»çµ±ç‹€æ…‹: æ­£å¸¸é‹è¡Œ`, 'success');
                addMessage('systemStatus', `å¯ç”¨æœå‹™: ${data.services.join(', ')}`, 'info');
                
                // é¡¯ç¤ºè©³ç´°ç‹€æ…‹
                const statusDiv = document.createElement('div');
                statusDiv.className = 'json-display';
                statusDiv.textContent = JSON.stringify(data, null, 2);
                document.getElementById('systemStatus').appendChild(statusDiv);
                
            } catch (error) {
                addMessage('systemStatus', `ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰çµæœ
        function clearAllResults() {
            document.getElementById('basicResult').innerHTML = '';
            document.getElementById('clarificationResult').innerHTML = '';
            document.getElementById('systemStatus').innerHTML = '';
            
            // é‡ç½®çµ±è¨ˆ
            stats = {
                totalQueries: 0,
                clarificationTriggered: 0,
                totalResponseTime: 0,
                successfulQueries: 0
            };
            updateStats();
            
            currentConversationId = null;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            updateStats();
            addMessage('systemStatus', 'æ¸¬è©¦ä»‹é¢å·²è¼‰å…¥ï¼Œé»æ“Š"æª¢æŸ¥ç³»çµ±ç‹€æ…‹"ä¾†é©—è­‰å¾Œç«¯é€£æ¥', 'info');
        };
    </script>
</body>
</html>